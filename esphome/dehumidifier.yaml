esphome:
  name: deshumidifcateurblancsdb
  friendly_name: DeshumidifcateurBlancSdb
  platformio_options:
    board_build.flash_mode: dio

esp32:
  board: esp32-c3-devkitm-1
  framework:
    type: esp-idf

# Enable logging
logger:

# Enable Home Assistant API
api:
  encryption:
    key: "4AsXymGVGnbyN1UXdQ4qsTEd3DJWJzVDGleM7FqNhdw="

ota:
  - platform: esphome
    password: "f4f7f7a1b1f838a8001fe847e2dc5af8"

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  # Force les paramètres de connexion
  power_save_mode: none
  fast_connect: true
  output_power: 20dB
  reboot_timeout: 15min
  enable_on_boot: true

captive_portal:
    
# Sensors
sensor:
  - platform: adc
    pin: GPIO3
    id: dehum_voltage
    update_interval: 1s
    attenuation: 12db
    internal: true
    filters:
      - multiply: 2.0
      - sliding_window_moving_average:
          window_size: 5
          send_every: 1

  
  # WiFi Signal Strength
  - platform: wifi_signal
    name: "WiFi Signal"
    id: wifi_rssi
    update_interval: 60s
    filters:
      - sliding_window_moving_average:
          window_size: 3
          send_every: 1

  # WiFi Signal en pourcentage
  - platform: wifi_signal
    name: "WiFi Signal Percent"
    id: wifi_signal_percent
    update_interval: 60s
    filters:
      - lambda: |-
          if (x <= -100) return 0;
          if (x >= -50) return 100;
          return 2 * (x + 100);

text_sensor:
  - platform: wifi_info
    ip_address:
      id: wifi_ip_address
      name: "IP Address"
      icon: "mdi:wan"
      entity_category: "diagnostic"
    bssid:
      id: wifi_bssid
      name: "BSSID"
      icon: "mdi:wan"
      entity_category: "diagnostic"
  - platform: template
    id: dehum_last_change
    name: "Dehumidifier Last Change"


# État binaire ON/OFF basé sur la tension du LED
binary_sensor:
  - platform: template
    id: dehum_running
    name: "Dehumidifier Running"
    device_class: running
    lambda: |-
      static bool last_state = false;
      float v = id(dehum_voltage).state;

      if (!last_state && v > 2.0) {
        last_state = true;
        return true;
      }

      if (last_state && v < 0.1) {
        last_state = false;
        return false;
      }

      return last_state;
    on_state:
      - text_sensor.template.publish:
          id: dehum_last_change
          state: !lambda |-
            char buf[32];
            time_t now = id(esptime).now().timestamp;
            strftime(buf, sizeof(buf), "%Y-%m-%d %H:%M:%S", localtime(&now));
            return std::string(buf);

time:
  - platform: homeassistant
    id: esptime

# Contrôle du touch button via PN2222
switch:
  - platform: gpio
    pin: GPIO5
    id: touch_pin
    internal: true  # Caché dans Home Assistant
    inverted: false
    
  - platform: template
    name: "Dehumidifier Power"
    icon: "mdi:air-humidifier"
    optimistic: false
    lambda: |-
      return id(dehum_running).state;
    turn_on_action:
      - if:
          condition:
            binary_sensor.is_off: dehum_running
          then:
            - logger.log: "Turning ON dehumidifier"
            - switch.turn_on: touch_pin
            - delay: 500ms
            - switch.turn_off: touch_pin
    turn_off_action:
      - if:
          condition:
            binary_sensor.is_on: dehum_running
          then:
            - logger.log: "Turning OFF dehumidifier"
            - switch.turn_on: touch_pin
            - delay: 200ms
            - switch.turn_off: touch_pin
